import * as admin from "firebase-admin";
import { onMessagePublished } from "firebase-functions/v2/pubsub";
import { sanitizeData } from "../utils";

const REGION = "{{region}}";

{{#each functions}}
{{#if (eq trigger "onMessagePublished")}}
export const {{name}}{{../testRunId}} = onMessagePublished({
  topic: "{{topic}}",
  region: REGION,
  timeoutSeconds: {{timeout}}
}, async (event) => {
  const message = event.data.message;
  const testId = (message.json as { testId?: string })?.testId;

  await admin
    .firestore()
    .collection("{{collection}}")
    .doc(testId)
    .set(
      sanitizeData({
        ...event,
        message: JSON.stringify(message),
      })
    );
});
{{/if}}

{{/each}}