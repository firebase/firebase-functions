import * as admin from "firebase-admin";
import * as functions from "firebase-functions/v1";
import { sanitizeData } from "../utils";

const REGION = "{{region}}";

{{#each functions}}
export const {{name}}{{../testRunId}} = functions
  .runWith({
    timeoutSeconds: {{timeout}}
  })
  .region(REGION)
  .testLab.testMatrix()
  .onComplete(async (matrix: unknown, context) => {
    if (!matrix || typeof matrix !== "object" || !("clientInfo" in matrix)) {
      console.error("Invalid matrix structure for test matrix completion");
      return;
    }
    const clientInfo = (matrix as { clientInfo: unknown }).clientInfo;
    if (!clientInfo || typeof clientInfo !== "object" || !("details" in clientInfo)) {
      console.error("Invalid clientInfo structure for test matrix completion");
      return;
    }
    const details = clientInfo.details;
    if (!details || typeof details !== "object" || !("testId" in details)) {
      console.error("Invalid details structure for test matrix completion");
      return;
    }
    const testId = details.testId as string;

    await admin
      .firestore()
      .collection("{{collection}}")
      .doc(testId)
      .set(
        sanitizeData({
          ...context,
          matrix: JSON.stringify(matrix),
        })
      );
  });

{{/each}}